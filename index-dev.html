<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="./static/site/img/favicon.svg">

  <title>Bathymetric data visualization Top</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>

  <style type="text/css">
    * {
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 62.5%;
    }

    body {
      font-size: 1.4em;
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
      overflow: hidden;
      background-color: #000;
    }

    #map {
      width: 100vw;
      height: 100vh;
    }

    canvas {
      display: block;
    }

    .leaflet-interactive {
      cursor: pointer;
    }

    .area-marker {
      background-color: #3388ff;
      border: 2px solid white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      cursor: pointer;
    }

    .area-label {
      background: none;
      border: none;
      box-shadow: none;
      text-align: center;
      cursor: pointer;
    }

    .area-label-pin {
      font-size: 3em;
      line-height: 1;
      filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.5));
    }

    .area-label-text {
      font-weight: bold;
      color: #3388ff;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 1.4em;
      white-space: nowrap;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      margin-top: 4px;
      display: inline-block;
    }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
    .leaflet-tooltip {
      font-size: 1.6em !important;
      padding: 10px 15px !important;
      line-height: 1.6 !important;
      background-color: rgba(255, 255, 255, 0.95) !important;
      border: 2px solid #3388ff !important;
      border-radius: 6px !important;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3) !important;
    }

    .leaflet-popup-content-wrapper {
      font-size: 1.6em !important;
      padding: 5px !important;
    }

    .leaflet-popup-content {
      margin: 15px 20px !important;
      line-height: 1.6 !important;
    }

    .leaflet-popup-content strong {
      font-size: 1.2em !important;
      display: block;
      margin-bottom: 8px;
    }
  </style>

</head>

<body>
  <div id="map"></div>
</body>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""></script>

<script type="module">

  window.addEventListener("load", async () => {
    // ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨€èªè¨­å®šã‚’å–å¾—ï¼ˆæ—¥æœ¬èªã‹ãã‚Œä»¥å¤–ï¼‰
    const isJapanese = navigator.language.startsWith('ja');

    // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã®é–¾å€¤ï¼ˆã“ã®å€¤ä»¥ä¸‹ã§ã¯ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤ºï¼‰
    const ZOOM_THRESHOLD = 11;

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåº§æ¨™ï¼ˆæ±äº¬é§…ä»˜è¿‘ï¼‰
    const defaultLat = 35.6812;
    const defaultLon = 139.7671;
    const defaultZoom = 13;

    let map;
    let centerLat = defaultLat;
    let centerLon = defaultLon;
    let initialZoom = defaultZoom;
    let geojsonLayer = null;
    let markerLayer = null;
    let geojsonData = null;

    // ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤ºç”¨ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆ
    function createMarkerLayer(data) {
      const markers = [];

      data.features.forEach(feature => {
        if (feature.properties && feature.properties.center_lat && feature.properties.center_lon) {
          const lat = feature.properties.center_lat;
          const lon = feature.properties.center_lon;
          const name = feature.properties.name || (isJapanese ? 'åå‰ãªã—' : 'No name');

          // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³ã§ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆï¼ˆã‚ˆã‚Šå¤§ããç›®ç«‹ã¤ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰
          const icon = L.divIcon({
            className: 'area-label',
            html: `
              <div style="text-align: center;">
                <div class="area-label-pin">ğŸ“</div>
                <div class="area-label-text">${name}</div>
              </div>
            `,
            iconSize: [200, 80],
            iconAnchor: [100, 40]
          });

          const marker = L.marker([lat, lon], { icon: icon });

          // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
          marker.on('click', () => {
            const linkUrl = feature.properties.link || './index-bathymetric-data-dev.html';
            window.location.href = linkUrl;
          });

          // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—
          const tooltipContent = isJapanese ?
            `<strong>${name}</strong><br>ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ãƒšãƒ¼ã‚¸ã‚’é–‹ãã¾ã™` :
            `<strong>${name}</strong><br>Click to open details page`;

          marker.bindTooltip(tooltipContent, {
            direction: 'top',
            offset: [0, -40],
            className: 'custom-tooltip'
          });

          markers.push(marker);
        }
      });

      return L.layerGroup(markers);
    }

    // GeoJSONãƒãƒªã‚´ãƒ³è¡¨ç¤ºç”¨ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆ
    function createGeoJSONLayer(data) {
      return L.geoJSON(data, {
        style: {
          color: '#3388ff',
          weight: 2,
          opacity: 0.8,
          fillOpacity: 0.3
        },
        onEachFeature: (feature, layer) => {
          // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
          layer.on('click', (e) => {
            const linkUrl = feature.properties.link || './index-bathymetric-data-dev.html';
            window.location.href = linkUrl;
          });

          // ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼ã§ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’è¡¨ç¤º
          if (feature.properties) {
            const props = feature.properties;
            const popupContent = isJapanese ?
              `<strong>${props.name || 'åå‰ãªã—'}</strong><br>
               ${props.description || ''}<br>
               <em>ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ãƒšãƒ¼ã‚¸ã‚’é–‹ãã¾ã™</em>` :
              `<strong>${props.name || 'No name'}</strong><br>
               ${props.description || ''}<br>
               <em>Click to open details page</em>`;

            layer.bindTooltip(popupContent, {
              sticky: true,
              opacity: 0.95,
              className: 'custom-tooltip'
            });

            // ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            layer.on('mouseover', (e) => {
              layer.setStyle({
                fillOpacity: 0.5,
                weight: 3
              });
            });

            // ãƒã‚¦ã‚¹ã‚¢ã‚¦ãƒˆã§å…ƒã«æˆ»ã™
            layer.on('mouseout', (e) => {
              layer.setStyle({
                fillOpacity: 0.3,
                weight: 2
              });
            });
          }
        }
      });
    }

    // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    function updateLayerByZoom() {
      const currentZoom = map.getZoom();

      if (currentZoom <= ZOOM_THRESHOLD) {
        // ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆæ™‚: ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
        if (geojsonLayer && map.hasLayer(geojsonLayer)) {
          map.removeLayer(geojsonLayer);
        }
        if (markerLayer && !map.hasLayer(markerLayer)) {
          map.addLayer(markerLayer);
        }
      } else {
        // ã‚ºãƒ¼ãƒ ã‚¤ãƒ³æ™‚: ãƒãƒªã‚´ãƒ³è¡¨ç¤º
        if (markerLayer && map.hasLayer(markerLayer)) {
          map.removeLayer(markerLayer);
        }
        if (geojsonLayer && !map.hasLayer(geojsonLayer)) {
          map.addLayer(geojsonLayer);
        }
      }
    }

    try {
      // GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
      const response = await fetch('./data/ALL_depth_map_data_202510.geojson');

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      geojsonData = await response.json();

      // æœ€åˆã®featureã®propertiesã‹ã‚‰ä¸­å¿ƒåº§æ¨™ã‚’å–å¾—
      const firstFeature = geojsonData.features[0];
      centerLat = firstFeature.properties.center_lat || defaultLat;
      centerLon = firstFeature.properties.center_lon || defaultLon;

      // åœ°å›³ã®åˆæœŸåŒ–ï¼ˆGeoJSONã®ä¸­å¿ƒåº§æ¨™ã‚’ä½¿ç”¨ï¼‰
      map = L.map('map').setView([centerLat, centerLon], 11);

      // OpenStreetMapã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);

      // ä¸¡æ–¹ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½œæˆ
      geojsonLayer = createGeoJSONLayer(geojsonData);
      markerLayer = createMarkerLayer(geojsonData);

      // åˆæœŸè¡¨ç¤º
      updateLayerByZoom();

      // ã‚ºãƒ¼ãƒ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      map.on('zoomend', updateLayerByZoom);

      // GeoJSONã®ç¯„å›²ã«åœ°å›³ã‚’ãƒ•ã‚£ãƒƒãƒˆ
      map.fitBounds(geojsonLayer.getBounds(), {
        padding: [100, 100],
        maxZoom: 13
      });

    } catch (error) {
      console.error('GeoJSONã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);

      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯æ±äº¬é§…ä»˜è¿‘ã‚’è¡¨ç¤º
      map = L.map('map').setView([defaultLat, defaultLon], defaultZoom);

      // OpenStreetMapã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 19
      }).addTo(map);

      const error_message = isJapanese ?
        `<strong>æ±äº¬é§…</strong><br>GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ±äº¬é§…ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚` :
        `<strong>Tokyo Station</strong><br>Failed to load GeoJSON file, displaying Tokyo Station.`;

      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒãƒ¼ã‚«ãƒ¼ã¨ã—ã¦è¡¨ç¤º
      L.marker([defaultLat, defaultLon])
        .addTo(map)
        .bindPopup(error_message)
        .openPopup();
    }
  });

</script>

</html>